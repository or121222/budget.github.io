<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Budget Master Ultimate v11</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4e54c8">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="apple-touch-icon" href="icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ========================================= */
        /* === MAIN APP STYLES (Budget System) === */
        /* ========================================= */
        :root {
            --bg-color: #f0f2f5;
            --card-bg: rgba(255, 255, 255, 0.98);
            --text-main: #2d3436;
            --text-sec: #636e72;
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --danger: #ff7675;
            --warning: #fdcb6e;
            --success: #00b894;
            --glass-border: 1px solid rgba(255, 255, 255, 0.6);
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --nav-height: 70px;
            --safe-area-top: env(safe-area-inset-top, 20px);
        }

        body.dark-mode {
            --bg-color: #1e272e;
            --card-bg: rgba(45, 52, 54, 0.98);
            --text-main: #dfe6e9;
            --text-sec: #b2bec3;
            --primary: #6c5ce7;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            padding-bottom: 100px;
            user-select: none;
        }

        /* --- Page Layouts --- */
        .page { display: none; animation: fadeIn 0.3s ease; padding-bottom: 80px; }
        .page.active { display: block; }

        /* --- Main Header --- */
        header.app-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: calc(var(--safe-area-top) + 15px) 20px 40px 20px;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(78, 84, 200, 0.4);
            margin-bottom: 20px;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .header-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; backdrop-filter: blur(5px); }
        .total-balance { font-size: 3rem; font-weight: 700; direction: ltr; margin: 5px 0 15px 0; text-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .month-selector { display: flex; justify-content: center; align-items: center; gap: 20px; font-size: 1.3rem; font-weight: 600; color: white; margin-bottom: 20px; }
        .month-arrow { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 1rem; padding: 8px 12px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(4px); }

        /* Header Inputs */
        .header-inputs { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .h-input-box { background: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.3); border-radius: 15px; padding: 10px; backdrop-filter: blur(5px); text-align: center; }
        .h-input-box label { font-size: 0.8rem; opacity: 0.9; display: block; margin-bottom: 2px; }
        .h-input-box input { width: 100%; background: transparent; border: none; text-align: center; font-size: 1.2rem; font-weight: bold; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .h-input-box input::placeholder { color: rgba(255,255,255,0.6); }

        .motivation-box { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 12px; padding: 10px 15px; margin-top: 10px; backdrop-filter: blur(4px); min-height: 40px; display: flex; align-items: center; justify-content: center; }
        .motivation-text { color: rgba(255,255,255,0.95); font-size: 1rem; font-style: italic; }

        /* --- Dashboard Categories --- */
        #categories-container { max-width: 800px; margin: 0 auto; padding: 0 15px; display: flex; flex-direction: column; gap: 15px; }
        .category-card { background: var(--card-bg); border-radius: 15px; box-shadow: var(--shadow); border: var(--glass-border); overflow: hidden; }
        .card-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .cat-info { display: flex; align-items: center; gap: 10px; }
        .cat-emoji { background: rgba(100,100,100,0.1); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; }
        .cat-limit { font-size: 0.8rem; color: var(--text-sec); text-decoration: underline; cursor: pointer; background: rgba(0,0,0,0.05); padding: 2px 6px; border-radius: 4px; }
        .current-spend { font-size: 1.1rem; font-weight: bold; direction: ltr; }
        .progress-track { height: 6px; background: rgba(0,0,0,0.05); margin: 0 15px 10px 15px; border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; transition: width 0.5s ease; border-radius: 3px; }
        .bg-green { background: var(--success); } .bg-yellow { background: var(--warning); } .bg-red { background: var(--danger); }
        .items-list { list-style: none; border-top: 1px solid rgba(0,0,0,0.05); }
        .item-row { display: flex; justify-content: space-between; padding: 12px 15px; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 0.95rem; }
        .amount-pos { color: var(--success); font-weight: bold; } .amount-neg { color: var(--danger); font-weight: bold; }
        
        .quick-add { padding: 15px; background: rgba(0,0,0,0.02); display: flex; flex-direction: column; gap: 10px; }
        .qa-row { display: flex; gap: 10px; }
        .qa-input { padding: 12px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1); background: var(--card-bg); color: var(--text-main); font-size: 1rem; flex: 1; }
        .qa-btn { background: var(--text-main); color: var(--bg-color); border: none; width: 100%; padding: 12px; border-radius: 10px; font-weight: bold; font-size: 1rem; display: flex; justify-content: center; align-items: center; gap: 5px; }

        .chart-container-card { max-width: 800px; margin: 20px auto; padding: 0 15px; }
        .chart-wrapper { background: var(--card-bg); border-radius: 15px; box-shadow: var(--shadow); border: var(--glass-border); padding: 15px; height: 250px; }

        /* Recurring & Premium Shared */
        .recur-item { background: var(--card-bg); padding: 15px; margin: 10px 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: var(--shadow); }
        .recur-add-box { background: var(--card-bg); padding: 20px; margin: 15px; border-radius: 15px; box-shadow: var(--shadow); }
        .btn-primary { width: 100%; background: var(--primary); color: white; border: none; padding: 12px; border-radius: 10px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .ad-spacer { height: 60px; width: 100%; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: var(--card-bg); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; backdrop-filter: blur(10px); border-top: var(--glass-border); }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 0.7rem; cursor: pointer; padding: 8px; flex: 1; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item i { font-size: 1.3rem; margin-bottom: 4px; }

        /* FAB & Modals */
        .fab { position: fixed; bottom: 100px; left: 20px; background: var(--primary); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 1.8rem; box-shadow: 0 4px 15px rgba(78, 84, 200, 0.5); cursor: pointer; border: none; z-index: 95; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.open { opacity: 1; pointer-events: all; }
        .modal-card { background: var(--bg-color); width: 100%; max-width: 400px; padding: 25px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; }
        .emoji-grid { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; }
        .emoji-opt { font-size: 1.5rem; cursor: pointer; padding: 5px; border-radius: 5px; }

        /* ========================================= */
        /* === SALARY CALCULATOR STYLES (NEW) === */
        /* ========================================= */
        /* Prefixing with 'ssc-' to avoid conflicts */
        
        .ssc-wrap { padding: 15px; font-family:"Segoe UI",system-ui,Arial,sans-serif; color: #111827; }
        .ssc-badge { background:#3b82f6; color:#fff; padding:4px 12px; border-radius:99px; font-size:14px; font-weight:bold; }
        .ssc-badge.mishmar { background:#ef4444; }

        .ssc-panel { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 8px 30px rgba(0,0,0,.06); margin-bottom:16px; }
        .ssc-row { display:flex; flex-wrap:wrap; gap:12px; align-items:end; margin-bottom: 10px; }
        .ssc-row label small { display:block; color:#6b7280; font-size:12px; margin-bottom:4px; }
        
        .ssc-inp, .ssc-sel { appearance:none; border:1px solid #e5e7eb; background:#fff; padding:10px 12px; border-radius:12px; font-size:14px; outline:none; transition:.2s; width: 100%; }
        .ssc-inp:focus { border-color:#3b82f6; }

        .ssc-btn { border:1px solid transparent; padding:9px 14px; border-radius:12px; font-weight:600; cursor:pointer; transition:.2s; font-size:14px; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
        .ssc-btn.acc { background:#10b981; color:#fff; }
        .ssc-btn.info { background:#3b82f6; color:#fff; }
        .ssc-btn.warn { background:#f59e0b; color:#fff; }
        .ssc-btn.danger { background:#ef4444; color:#fff; }
        .ssc-btn.ghost { background:transparent; border-color:#e5e7eb; }

        .ssc-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:10px; }
        .ssc-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:14px; box-shadow:0 6px 22px rgba(0,0,0,.05); display:flex; flex-direction:column; gap:10px; position:relative; }
        .ssc-card h3 { margin:0; font-size:15px; font-weight:700; }
        .ssc-del-cat { position:absolute; top:5px; left:5px; color:#ef4444; background:none; border:none; cursor:pointer; opacity:0.6; font-size:16px; }
        
        .ssc-meta { color:#6b7280; font-size:11px; }
        .ssc-counter { display:flex; gap:8px; align-items:center; justify-content:space-between; background:#f3f4f6; padding:4px; border-radius:12px; }
        .ssc-count { font-size:20px; font-weight:800; min-width:30px; text-align:center; }
        .ssc-iconbtn { border:1px solid #e5e7eb; background:#fff; width:32px; height:32px; border-radius:10px; font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; }

        .ssc-summary { display:flex; flex-wrap:wrap; gap:16px; align-items:center; justify-content:space-between; background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:18px; box-shadow:0 8px 30px rgba(0,0,0,.06); }
        .ssc-total { font-size:24px; font-weight:900; }

        .ssc-table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; }
        .ssc-table th, .ssc-table td { padding:10px; border-bottom:1px solid #e5e7eb; text-align:center; font-size:13px; }
        .ssc-table thead th { background:#f8fafc; color:#334155; font-weight:600; }

        .ssc-editor-slice { display:flex; gap:8px; margin-bottom:8px; align-items:center; }
        #ssc_editorPanel { border-color:#3b82f6; border-width:2px; display:none; }

        .ssc-secret-box { display:flex; gap:8px; justify-content: center; margin-top: 20px;}

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="page-dashboard" class="page active">
        <header class="app-header">
            <div class="header-top">
                <button class="header-btn" onclick="toggleDarkMode()"><i class="fas fa-moon"></i></button>
                <div style="font-weight:700">Budget Master</div>
                <button class="header-btn" onclick="exportToCSV()"><i class="fas fa-file-export"></i></button>
            </div>
            
            <div class="month-selector">
                <button class="month-arrow" onclick="changeMonth(-1)"><i class="fas fa-chevron-right"></i></button>
                <span id="current-month-display">--</span>
                <button class="month-arrow" onclick="changeMonth(1)"><i class="fas fa-chevron-left"></i></button>
            </div>

            <div class="total-balance" id="global-balance">â‚ª0.00</div>

            <div class="header-inputs">
                <div class="h-input-box">
                    <label>×¢×•"×© ×‘×‘× ×§</label>
                    <input type="number" id="bank-input" placeholder="0" oninput="saveAndRender()">
                </div>
                <div class="h-input-box">
                    <label>××©×›×•×¨×ª (×—×•×“×© ×–×”)</label>
                    <input type="number" id="salary-input" placeholder="0" oninput="updateSalary()">
                </div>
            </div>

            <div class="motivation-box">
                <i class="fas fa-quote-right" style="margin-left:5px; opacity:0.8"></i>
                <span class="motivation-text" id="motivation-text">×˜×•×¢×Ÿ...</span>
            </div>
        </header>

        <div id="categories-container"></div>
        <div class="chart-container-card"><div class="chart-wrapper"><canvas id="expenseChart"></canvas></div></div>
        <div class="ad-spacer"></div>
        <button class="fab" onclick="openCategoryModal()"><i class="fas fa-plus"></i></button>
    </div>

    <div id="page-recurring" class="page">
        <header class="app-header" style="padding-bottom: 20px;"><h2>×”×•×¦××•×ª ×§×‘×•×¢×•×ª</h2></header>
        <div id="recurring-list-container"></div>
        <div class="recur-add-box">
            <h3>×”×•×¡×¤×” ×—×“×©×”</h3>
            <input type="text" id="rec-desc" class="qa-input" style="width:100%; margin-bottom:10px" placeholder="×©× (×œ××©×œ: × ×˜×¤×œ×™×§×¡)">
            <input type="number" id="rec-amount" class="qa-input" style="width:100%; margin-bottom:10px" placeholder="×¡×›×•×">
            <select id="rec-cat-select" class="qa-input" style="width:100%"></select>
            <button class="btn-primary" onclick="addRecurringSetting()">×©××•×¨</button>
        </div>
        <div class="ad-spacer"></div>
    </div>

    <div id="page-calc" class="page">
        <div class="ssc-wrap">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div>
                    <h2 style="margin:0; font-size:24px; color:var(--primary)">×—×™×©×•×‘ ×©×›×¨</h2>
                    <span id="ssc_modeBadge" class="ssc-badge">××¦×‘ ×¢×¨×™×›×” ×—×•×¤×©×™</span>
                </div>
                <button class="ssc-btn ghost" id="ssc_resetMonth" style="font-size:12px;">××™×¤×•×¡</button>
            </div>

            <div class="ssc-row">
                <label style="flex:1"><small>×©×›×¨ ×œ×©×¢×”</small><input id="ssc_hourly" type="number" step="0.1" placeholder="0" class="ssc-inp"></label>
                <label style="flex:1"><small>×—×•×“×©</small><input id="ssc_month" type="month" class="ssc-inp"></label>
                <label style="flex:1"><small>××˜×‘×¢</small><select id="ssc_currency" class="ssc-sel"><option value="â‚ª">â‚ª</option><option value="$">$</option></select></label>
            </div>

            <section class="ssc-panel" id="ssc_editorPanel">
                <h3 style="margin-top:0;color:#3b82f6">×”×•×¡×¤×ª ×¡×•×’ ××©××¨×ª</h3>
                <div class="ssc-row" style="align-items:flex-start">
                    <div style="flex:1;">
                        <label><small>×©× ×”××©××¨×ª</small><input type="text" id="ssc_newShiftName" placeholder="×œ×“×•×’××”: ×œ×™×œ×”" class="ssc-inp"></label>
                    </div>
                    <div style="flex:1">
                        <label><small>×”×¨×›×‘ (×©×¢×•×ª/××—×•×–×™×)</small></label>
                        <div id="ssc_newShiftSlices"></div>
                        <button class="ssc-btn ghost" id="ssc_addSliceBtn" style="margin-top:4px;font-size:11px;">+ ×”×•×¡×£ ××“×¨×’×”</button>
                    </div>
                </div>
                <div style="text-align:left; margin-top:10px;">
                    <button class="ssc-btn acc" id="ssc_saveTemplateBtn">×©××•×¨ ×¡×•×’</button>
                </div>
            </section>

            <section class="ssc-panel">
                <div class="ssc-grid" id="ssc_grid"></div>
                <div id="ssc_emptyState" style="text-align:center;padding:20px;color:#999;display:none;font-size:14px;">
                    ××™×Ÿ ××©××¨×•×ª.<br>×”×©×ª××© ×‘×¢×•×¨×š ×œ××¢×œ×”.
                </div>
            </section>

            <section style="display:grid; gap:16px;">
                <div class="ssc-summary">
                    <div><div class="ssc-meta">×¡×”×´×› ××©××¨×•×ª</div><div class="ssc-total" id="ssc_totalShifts">0</div></div>
                    <div><div class="ssc-meta" style="text-align:end">×©×¢×•×ª</div><div class="ssc-total" id="ssc_totalHours" style="text-align:end">0</div></div>
                    <div style="text-align:end"><div class="ssc-meta">×©×›×¨ ××©×•×¢×¨</div><div class="ssc-total" id="ssc_grandTotal">â‚ª0</div></div>
                </div>

                <div class="ssc-panel" style="margin:0">
                    <div style="font-weight:700;margin-bottom:8px">××—×©×‘×•×Ÿ ×—×•×¤×©×™ (×ª×•×¡×¤×•×ª)</div>
                    <div id="ssc_quickRows"></div>
                    <div class="ssc-row" style="margin-top:8px">
                        <button class="ssc-btn acc" id="ssc_addQuick" style="font-size:12px">×”×•×¡×£ ×©×•×¨×”</button>
                        <span style="flex:1"></span>
                        <b><span id="ssc_quickSum">0</span></b>
                    </div>
                </div>
            </section>

            <section class="ssc-panel">
                <div style="overflow-x:auto">
                    <table class="ssc-table">
                        <thead><tr><th>×¡×•×’</th><th>×›××•×ª</th><th>×©×¢×•×ª</th><th>×¡×”×´×›</th></tr></thead>
                        <tbody id="ssc_details"></tbody>
                        <tfoot><tr><td colspan="3">×¡×”×´×› ×›×•×œ×œ</td><td id="ssc_detailsTotal">0</td></tr></tfoot>
                    </table>
                </div>
            </section>

            <div class="ssc-secret-box">
                <input type="text" id="ssc_secretCode" class="ssc-inp" placeholder="×§×•×“ ××¢×¨×›×ª..." style="width:150px">
                <button class="ssc-btn info" id="ssc_secretBtn">×”×¤×¢×œ</button>
            </div>
            <div style="text-align:center; font-size:11px; color:#888; margin-top:5px;">×¨××–: "××©××¨" / "×¨×’×™×œ"</div>
        </div>
        <div class="ad-spacer"></div>
    </div>

    <div id="page-premium" class="page">
        <header class="app-header" style="padding-bottom: 20px;"><h2>Premium</h2></header>
        <div id="premium-content" style="padding: 20px; text-align: center;">
            <div style="background: linear-gradient(135deg, #FFD700, #FDB931); padding:30px; border-radius:20px; color:#333; box-shadow:0 10px 20px rgba(0,0,0,0.1);">
                <h1><i class="fas fa-crown"></i></h1>
                <h2>×©×“×¨×•×’ ×œ×¤×¨×•</h2>
                <p>×”×¡×¨×ª ×¤×¨×¡×•××•×ª, ×’×™×‘×•×™ ×‘×¢× ×Ÿ ×•×ª××™×›×”.</p>
                <button class="btn-primary" style="background:#333; margin-top:20px" onclick="buyPremium()">×”×™×¨×©× (â‚ª9.90)</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <div class="nav-item active" onclick="switchPage('dashboard', this)"><i class="fas fa-home"></i><span>×¨××©×™</span></div>
        <div class="nav-item" onclick="switchPage('recurring', this)"><i class="fas fa-sync-alt"></i><span>×§×‘×•×¢×•×ª</span></div>
        <div class="nav-item" onclick="switchPage('calc', this)"><i class="fas fa-calculator"></i><span>××—×©×‘×•×Ÿ</span></div>
        <div class="nav-item" onclick="switchPage('premium', this)"><i class="fas fa-star"></i><span>×¤×¨×™××™×•×</span></div>
    </nav>

    <div id="cat-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>×§×˜×’×•×¨×™×” ×—×“×©×”</h3>
            <input type="text" id="new-cat-name" class="qa-input" style="width:100%; margin-bottom:15px" placeholder="×©× ×”×§×˜×’×•×¨×™×”">
            <div style="margin-bottom:15px; text-align:right">
                <label style="font-size:0.8rem; color:#666">×‘×—×¨ ×¡××œ:</label>
                <div class="emoji-grid">
                    <span class="emoji-opt" onclick="selectEmoji('ğŸ•')">ğŸ•</span><span class="emoji-opt" onclick="selectEmoji('ğŸš—')">ğŸš—</span>
                    <span class="emoji-opt" onclick="selectEmoji('ğŸ ')">ğŸ </span><span class="emoji-opt" onclick="selectEmoji('ğŸ‘•')">ğŸ‘•</span>
                </div>
                <input type="text" id="new-cat-emoji" class="qa-input" style="width:100%" placeholder="××• ×”×§×œ×“ ×›××Ÿ..." value="ğŸ“">
            </div>
            <input type="number" id="new-cat-limit" class="qa-input" style="width:100%; margin-bottom:15px" placeholder="×ª×§×¦×™×‘ (×œ××©×œ: 500)">
            <div style="display:flex; gap:10px;"><button class="btn-primary" style="background:#ccc; color:#333" onclick="closeCategoryModal()">×‘×™×˜×•×œ</button><button class="btn-primary" onclick="confirmAddCategory()">×”×•×¡×£</button></div>
        </div>
    </div>

    <div id="limit-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>×¢×“×›×•×Ÿ ×ª×§×¦×™×‘</h3>
            <p id="limit-modal-cat-name" style="margin-bottom:10px"></p>
            <input type="number" id="edit-cat-limit" class="qa-input" style="width:100%; margin-bottom:15px">
            <input type="hidden" id="edit-cat-id">
            <div style="display:flex; gap:10px;"><button class="btn-primary" style="background:#ccc; color:#333" onclick="document.getElementById('limit-modal').classList.remove('open')">×‘×™×˜×•×œ</button><button class="btn-primary" onclick="confirmEditLimit()">×¢×“×›×Ÿ</button></div>
        </div>
    </div>

    <script>
        /* ============================ */
        /* === MAIN APP LOGIC START === */
        /* ============================ */
        
        let currentDate = new Date();
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let chartInstance = null;

        const motivationQuotes = [
            "×”×“×¨×š ×œ×¢×•×©×¨ ××ª×—×™×œ×” ×‘×©×§×œ ×”×¨××©×•×Ÿ ×©×—×•×¡×›×™×.",
            "×œ× ××©× ×” ×›××” ××ª×” ××¨×•×•×™×—, ××©× ×” ×›××” ××ª×” ×©×•××¨.",
            "×ª×§×¦×™×‘ ×”×•× ×œ× ×›×œ×, ×”×•× ×”××¤×ª×— ×œ×—×•×¤×©.",
            "×›×¡×£ ×”×•× ××©×¨×ª × ×”×“×¨ ××‘×œ ××“×•×Ÿ × ×•×¨×.",
            "×”×©×§×¢×” ×‘×¢×¦××š ×× ×™×‘×” ××ª ×”×¨×™×‘×™×ª ×”×’×‘×•×”×” ×‘×™×•×ª×¨.",
            "×”×•×¦××•×ª ×§×˜× ×•×ª ××¦×˜×‘×¨×•×ª ×œ×”×•×Ÿ ×’×“×•×œ.",
            "×©×œ×™×˜×” ×‘×›×¡×£ ×”×™× ×©×œ×™×˜×” ×‘×—×™×™×.",
            "×”×¢×•×©×¨ ×”×××™×ª×™ ×”×•× ×”×©×§×˜ ×”× ×¤×©×™.",
            "××œ ×ª×§× ×” ××” ×©××ª×” ×œ× ×¦×¨×™×š, ×‘×›×¡×£ ×©××™×Ÿ ×œ×š.",
            "×ª×§×¦×™×‘ ×—×›× ×”×™×•× = ×—×•×¤×© ×›×œ×›×œ×™ ××—×¨."
        ];

        let appData = JSON.parse(localStorage.getItem('budgetUltimateDataV11')) || {
            categories: [
                { id: 1, name: '××–×•×Ÿ', emoji: 'ğŸ•', limit: 2000, items: [] },
                { id: 2, name: '×¨×›×‘', emoji: 'ğŸš—', limit: 800, items: [] },
                { id: 3, name: '×—×©×‘×•× ×•×ª', emoji: 'ğŸ ', limit: 1500, items: [] }
            ],
            bank: 0,
            monthlySalaries: {}, 
            recurringSettings: [],
            lastProcessedMonth: "",
            isPremium: false
        };

        // --- Init Main App ---
        document.addEventListener('DOMContentLoaded', () => {
            if(isDarkMode) document.body.classList.add('dark-mode');
            
            document.getElementById('bank-input').value = appData.bank || '';
            const rnd = Math.floor(Math.random() * motivationQuotes.length);
            document.getElementById('motivation-text').innerText = motivationQuotes[rnd];

            checkAndRunRecurring();
            updateMonthDisplay();
            renderApp();
            checkPremiumStatus();

            // Initialize the separate Salary Calculator Logic
            initSalaryCalculator();
        });

        // --- Navigation ---
        function switchPage(pageName, navEl) {
            document.querySelectorAll('.page').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`page-${pageName}`).classList.add('active');
            navEl.classList.add('active');
            
            if(pageName === 'dashboard') renderApp();
            if(pageName === 'recurring') renderRecurringPage();
        }

        // --- Dashboard Logic ---
        function getMonthKey(date) { return `${date.getMonth()}-${date.getFullYear()}`; }

        function updateSalary() {
            const val = document.getElementById('salary-input').value;
            const key = getMonthKey(currentDate);
            if (!appData.monthlySalaries) appData.monthlySalaries = {};
            appData.monthlySalaries[key] = val;
            saveAndRender();
        }

        function saveAndRender() {
            appData.bank = document.getElementById('bank-input').value;
            localStorage.setItem('budgetUltimateDataV11', JSON.stringify(appData));
            renderApp();
            if (typeof Android !== 'undefined' && Android.updateBalanceWidget) {
                Android.updateBalanceWidget(document.getElementById('global-balance').innerText);
            }
        }

        function renderApp() {
            const salaryInput = document.getElementById('salary-input');
            const key = getMonthKey(currentDate);
            salaryInput.value = (appData.monthlySalaries && appData.monthlySalaries[key]) ? appData.monthlySalaries[key] : '';

            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            let totalExpenses = 0;

            appData.categories.forEach(cat => {
                let filteredItems = cat.items.filter(item => {
                    const d = new Date(item.date);
                    return d.getMonth() === currentDate.getMonth() && d.getFullYear() === currentDate.getFullYear();
                });

                const catTotal = filteredItems.reduce((sum, item) => sum + item.amount, 0);
                totalExpenses += catTotal;

                const spentPos = Math.abs(Math.min(0, catTotal));
                const limit = cat.limit || 1000;
                const percent = Math.min(100, (spentPos / limit) * 100);
                let colorClass = percent > 100 ? 'bg-red' : (percent > 75 ? 'bg-yellow' : 'bg-green');
                let balanceStyle = percent >= 100 ? 'color:var(--danger)' : '';

                const card = document.createElement('div');
                card.className = 'category-card';
                card.innerHTML = `
                    <div class="card-header">
                        <div class="cat-info">
                            <div class="cat-emoji">${cat.emoji}</div>
                            <div>
                                <div style="font-weight:bold">${cat.name}</div>
                                <div class="cat-limit" onclick="openLimitModal(${cat.id})">×ª×§×¦×™×‘: ${limit} <i class="fas fa-pen" style="font-size:0.7rem"></i></div>
                            </div>
                        </div>
                        <div class="current-spend" style="${balanceStyle}">${formatMoney(catTotal)}</div>
                    </div>
                    <div class="progress-track"><div class="progress-fill ${colorClass}" style="width:${percent}%"></div></div>
                    <ul class="items-list">
                        ${filteredItems.map(item => `
                            <li class="item-row">
                                <span>${item.text} ${item.isAuto ? '<i class="fas fa-robot" title="×§×‘×•×¢" style="font-size:0.7rem"></i>' : ''}</span>
                                <div><span class="${item.amount < 0 ? 'amount-neg' : 'amount-pos'}">${formatMoney(Math.abs(item.amount))}</span><i class="fas fa-times" onclick="deleteItem(${cat.id}, '${item.id}')" style="margin-right:5px; color:#ccc;"></i></div>
                            </li>
                        `).join('')}
                    </ul>
                    <div class="quick-add">
                        <div class="qa-row"><input id="d-${cat.id}" class="qa-input" placeholder="×ª×™××•×¨"></div>
                        <div class="qa-row"><input id="a-${cat.id}" type="number" class="qa-input" placeholder="×¡×›×•×"></div>
                        <button class="qa-btn" onclick="addItem(${cat.id})"><i class="fas fa-plus"></i> ×”×•×¡×£</button>
                    </div>
                `;
                container.appendChild(card);
            });

            const bank = parseFloat(appData.bank) || 0;
            const salary = parseFloat(appData.monthlySalaries?.[key]) || 0;
            const total = bank + salary + totalExpenses;
            document.getElementById('global-balance').innerText = formatMoney(total);
            document.getElementById('global-balance').style.color = total < 0 ? 'var(--danger)' : 'white';
            renderHistoryChart();
        }

        // --- Chart ---
        function renderHistoryChart() {
            const ctx = document.getElementById('expenseChart').getContext('2d');
            let labels = [], data = [];
            for(let i=5; i>=0; i--) {
                let d = new Date(); d.setMonth(d.getMonth() - i);
                labels.push(d.toLocaleDateString('he-IL', {month:'short'}));
                let mTotal = 0;
                appData.categories.forEach(cat => {
                    cat.items.forEach(item => {
                        let iDate = new Date(item.date);
                        if(iDate.getMonth() === d.getMonth() && iDate.getFullYear() === d.getFullYear()) { if(item.amount < 0) mTotal += Math.abs(item.amount); }
                    });
                });
                data.push(mTotal);
            }
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: '×”×•×¦××•×ª', data, backgroundColor: '#4e54c8', borderRadius: 4 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display:false} }, scales: { y: { beginAtZero: true } } } });
        }

        // --- Recurring (Parallel Add) ---
        function renderRecurringPage() {
            const container = document.getElementById('recurring-list-container'); container.innerHTML = '';
            const select = document.getElementById('rec-cat-select');
            if(select) select.innerHTML = appData.categories.map(c => `<option value="${c.id}">${c.emoji} ${c.name}</option>`).join('');
            if (!appData.recurringSettings) appData.recurringSettings = [];
            
            if (appData.recurringSettings.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px; opacity:0.6">××™×Ÿ ×”×•×¨××•×ª ×§×‘×¢</div>'; return; }
            appData.recurringSettings.forEach((rec, index) => {
                const catName = appData.categories.find(c => c.id == rec.catId)?.name || '?';
                const el = document.createElement('div'); el.className = 'recur-item';
                el.innerHTML = `<div><div style="font-weight:bold">${rec.text}</div><div style="font-size:0.8rem; color:#666">${catName} â€¢ ${formatMoney(rec.amount)}</div></div><button style="border:none; background:none; color:var(--danger)" onclick="deleteRecurring(${index})"><i class="fas fa-trash"></i></button>`;
                container.appendChild(el);
            });
        }
        function addRecurringSetting() {
            const text = document.getElementById('rec-desc').value; const amount = parseFloat(document.getElementById('rec-amount').value); const catId = document.getElementById('rec-cat-select').value;
            if(!text || !amount) return;
            appData.recurringSettings.push({ text, amount, catId });
            const cat = appData.categories.find(c => c.id == catId);
            if(cat) { cat.items.push({ id: Date.now().toString(), text: text + ' (×§×‘×•×¢)', amount: -Math.abs(amount), date: currentDate.toISOString(), isAuto: true }); }
            saveAndRender(); document.getElementById('rec-desc').value = ''; document.getElementById('rec-amount').value = ''; renderRecurringPage(); alert('×”×•×¦××” ×§×‘×•×¢×” × ×•×¡×¤×”! (×”×™× ×’× × ×•×¡×¤×” ×œ×—×•×“×© ×”× ×•×›×—×™)');
        }
        function deleteRecurring(index) { appData.recurringSettings.splice(index, 1); localStorage.setItem('budgetUltimateDataV11', JSON.stringify(appData)); renderRecurringPage(); }
        function checkAndRunRecurring() {
            const now = new Date(); const currentMonthKey = `${now.getMonth()}-${now.getFullYear()}`;
            if(appData.lastProcessedMonth !== currentMonthKey) {
                if (appData.recurringSettings) {
                    appData.recurringSettings.forEach(rec => {
                        const cat = appData.categories.find(c => c.id == rec.catId);
                        if(cat) cat.items.push({ id: 'auto_'+Date.now()+Math.random(), text: rec.text, amount: -Math.abs(rec.amount), date: now.toISOString(), isAuto: true });
                    });
                }
                appData.lastProcessedMonth = currentMonthKey;
                localStorage.setItem('budgetUltimateDataV11', JSON.stringify(appData));
            }
        }

        // --- Standard Actions ---
        function addItem(catId) {
            const desc = document.getElementById(`d-${catId}`).value; const amount = document.getElementById(`a-${catId}`).value;
            if(!desc || !amount) return;
            const cat = appData.categories.find(c => c.id === catId);
            cat.items.push({ id: Date.now().toString(), text: desc, amount: -Math.abs(parseFloat(amount)), date: currentDate.toISOString() });
            saveAndRender();
        }
        function deleteItem(catId, itemId) {
            const cat = appData.categories.find(c => c.id === catId);
            cat.items = cat.items.filter(i => i.id !== itemId);
            saveAndRender();
        }

        // --- Utils & Modals ---
        function changeMonth(delta) { currentDate.setMonth(currentDate.getMonth() + delta); updateMonthDisplay(); renderApp(); }
        function updateMonthDisplay() { document.getElementById('current-month-display').innerText = currentDate.toLocaleDateString('he-IL', { month: 'long', year: 'numeric' }); }
        function openCategoryModal() { document.getElementById('cat-modal').classList.add('open'); }
        function closeCategoryModal() { document.getElementById('cat-modal').classList.remove('open'); }
        function selectEmoji(e) { document.getElementById('new-cat-emoji').value = e; }
        function confirmAddCategory() { const name = document.getElementById('new-cat-name').value; const limit = document.getElementById('new-cat-limit').value; const emoji = document.getElementById('new-cat-emoji').value || 'ğŸ“'; if(name) { appData.categories.push({ id: Date.now(), name, emoji, limit: parseFloat(limit)||1000, items: [] }); saveAndRender(); closeCategoryModal(); } }
        function openLimitModal(catId) { const cat = appData.categories.find(c => c.id === catId); document.getElementById('edit-cat-id').value = catId; document.getElementById('limit-modal-cat-name').innerText = "×¢×‘×•×¨: " + cat.name; document.getElementById('edit-cat-limit').value = cat.limit; document.getElementById('limit-modal').classList.add('open'); }
        function confirmEditLimit() { const catId = parseInt(document.getElementById('edit-cat-id').value); const newLimit = parseFloat(document.getElementById('edit-cat-limit').value); const cat = appData.categories.find(c => c.id === catId); if(cat && newLimit) { cat.limit = newLimit; saveAndRender(); document.getElementById('limit-modal').classList.remove('open'); } }
        function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); }
        function formatMoney(n) { return n.toLocaleString('he-IL', { style: 'currency', currency: 'ILS', maximumFractionDigits: 0 }); }
        function checkPremiumStatus() { if(appData.isPremium) { document.querySelectorAll('.ad-spacer').forEach(e=>e.style.display='none'); document.body.style.paddingBottom="80px"; } }
        function buyPremium() { if(confirm("×”×× ×œ××©×¨ ×¨×›×™×©×ª ×¤×¨×™××™×•×?")) { appData.isPremium = true; localStorage.setItem('budgetUltimateDataV11', JSON.stringify(appData)); checkPremiumStatus(); alert("×ª×•×“×” ×©× ×¨×©××ª!"); } }
        function exportToCSV() {}

        /* =========================================== */
        /* === NEW SALARY CALCULATOR LOGIC (v11) === */
        /* =========================================== */
        function initSalaryCalculator() {
            const $ = s => document.querySelector(s);
            const now = new Date();
            const ymDefault = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
            
            const KEY_MODE = 'ssc:mode'; 
            const KEY_CFG = 'ssc:cfg'; 
            const KEY_GENERIC_CATS = 'ssc:cats_generic';
            const KEY_COUNTS_PREFIX = 'ssc:counts:';
            const KEY_QUICK_PREFIX = 'ssc:quick:';

            // MISHMAR PRESETS
            const MISHMAR_CATS = [
                {id:'m1', name:'×‘×•×§×¨', slices:[{p:100,h:8}]},
                {id:'m2', name:'×¢×¨×‘', slices:[{p:120,h:8}]},
                {id:'m3', name:'×œ×™×œ×”', slices:[{p:150,h:8}]},
                {id:'m4', name:'×©×™×©×™ ×¢×¨×‘ (×§×™×¥) 18:00', slices:[{p:120,h:3},{p:250,h:5}]},
                {id:'m5', name:'×©×™×©×™/×©×‘×ª ×œ×™×œ×”', slices:[{p:300,h:8}]},
                {id:'m6', name:'×©×‘×ª ×‘×•×§×¨/×¢×¨×‘', slices:[{p:225,h:8}]},
                {id:'m7', name:'×¨×¦×£ ×¢×¨×‘ ×œ×‘×•×§×¨', slices:[{p:125,h:2},{p:150,h:6}]},
                {id:'m8', name:'×¨×¦×£ ×©×‘×ª ×œ×¨××©×•×Ÿ', slices:[{p:187,h:2},{p:225,h:6}]},
                {id:'m9', name:'×›×¤×•×œ×” 7-19', slices:[{p:100,h:8},{p:120,h:2},{p:150,h:2}]},
                {id:'m10', name:'×›×¤×•×œ×” 8-20', slices:[{p:100,h:7},{p:120,h:2},{p:125,h:1},{p:150,h:2}]},
                {id:'m11', name:'×›×¤×•×œ×” 9-21', slices:[{p:100,h:6},{p:120,h:2},{p:125,h:2},{p:150,h:2}]},
                {id:'m12', name:'×›×¤×•×œ×” 10-22', slices:[{p:100,h:5},{p:120,h:4},{p:125,h:2},{p:150,h:1}]},
                {id:'m13', name:'×›×¤×•×œ×” 11-23', slices:[{p:100,h:4},{p:120,h:4},{p:125,h:2},{p:150,h:2}]},
                {id:'m14', name:'×—×“ ×™×•××™ (5-21)', slices:[{p:100,h:8},{p:125,h:2},{p:150,h:4}]}
            ];

            const state = {
                mode: localStorage.getItem(KEY_MODE) || 'generic',
                hourly: 0,
                currency: 'â‚ª',
                ym: ymDefault,
                categories: [],
                counts: {},
                quickRows: []
            };

            const els = {
                badge: $('#ssc_modeBadge'),
                hourly: $('#ssc_hourly'), month: $('#ssc_month'), cur: $('#ssc_currency'),
                editor: $('#ssc_editorPanel'), newName: $('#ssc_newShiftName'), newSlices: $('#ssc_newShiftSlices'), addSlice: $('#ssc_addSliceBtn'), saveTpl: $('#ssc_saveTemplateBtn'),
                grid: $('#ssc_grid'), empty: $('#ssc_emptyState'),
                tShifts: $('#ssc_totalShifts'), tHours: $('#ssc_totalHours'), gTotal: $('#ssc_grandTotal'),
                details: $('#ssc_details'), dTotal: $('#ssc_detailsTotal'),
                quick: $('#ssc_quickRows'), addQuick: $('#ssc_addQuick'), quickSum: $('#ssc_quickSum'),
                secret: $('#ssc_secretCode'), secretBtn: $('#ssc_secretBtn'), resetMonth: $('#ssc_resetMonth')
            };

            loadConfig(); setupMode(); loadData(); renderAll();

            function setupMode(){
                if(state.mode === 'mishmar'){
                    els.badge.textContent = '××¦×‘ ××©××¨';
                    els.badge.className = 'ssc-badge mishmar';
                    els.editor.style.display = 'none';
                    state.categories = MISHMAR_CATS;
                } else {
                    els.badge.textContent = '××¦×‘ ×¢×¨×™×›×” ×—×•×¤×©×™';
                    els.badge.className = 'ssc-badge';
                    els.editor.style.display = 'block';
                    resetEditor();
                }
            }

            function loadConfig(){
                try{
                    const cfg = JSON.parse(localStorage.getItem(KEY_CFG)||'{}');
                    state.hourly = cfg.hourly || 0; state.currency = cfg.currency || 'â‚ª';
                    els.hourly.value = state.hourly || ''; els.month.value = state.ym; els.cur.value = state.currency;
                } catch(e){}
            }

            function loadData(){
                if(state.mode === 'generic'){
                    try { state.categories = JSON.parse(localStorage.getItem(KEY_GENERIC_CATS) || '[]'); } catch{ state.categories=[]; }
                    if(!state.categories.length) state.categories = [{id:'g1', name:'××©××¨×ª ×¨×’×™×œ×”', slices:[{p:100,h:8}]}];
                }
                const storeKey = `${KEY_COUNTS_PREFIX}${state.mode}:${state.ym}`;
                try { state.counts = JSON.parse(localStorage.getItem(storeKey) || '{}'); } catch { state.counts = {}; }
                const quickKey = `${KEY_QUICK_PREFIX}${state.mode}:${state.ym}`;
                try { state.quickRows = JSON.parse(localStorage.getItem(quickKey) || '[]'); } catch { state.quickRows = []; }
            }

            function saveData(){
                localStorage.setItem(KEY_CFG, JSON.stringify({hourly:state.hourly, currency:state.currency}));
                localStorage.setItem(`${KEY_COUNTS_PREFIX}${state.mode}:${state.ym}`, JSON.stringify(state.counts));
                localStorage.setItem(`${KEY_QUICK_PREFIX}${state.mode}:${state.ym}`, JSON.stringify(state.quickRows));
                if(state.mode === 'generic') localStorage.setItem(KEY_GENERIC_CATS, JSON.stringify(state.categories));
            }

            function resetEditor(){ els.newName.value = ''; els.newSlices.innerHTML = ''; addEditorSlice(100, 8); }
            function addEditorSlice(p=100, h=0){
                const div = document.createElement('div'); div.className = 'ssc-editor-slice';
                div.innerHTML = `<input type="number" class="ssc-inp e-p" value="${p}" style="width:60px" placeholder="%"><input type="number" class="ssc-inp e-h" value="${h}" step="0.5" style="width:60px" placeholder="×©×¢×•×ª"><button class="ssc-btn ghost danger" onclick="this.parentElement.remove()">Ã—</button>`;
                els.newSlices.appendChild(div);
            }

            function renderAll(){ renderGrid(); renderQuick(); calcAndRenderTotals(); }

            function renderGrid(){
                els.grid.innerHTML = '';
                if(!state.categories.length){ els.empty.style.display = 'block'; return; }
                els.empty.style.display = 'none';
                state.categories.forEach(c => {
                    const n = state.counts[c.id] || 0;
                    const info = getShiftInfo(c);
                    const subtotal = payForShift(c) * n;
                    const card = document.createElement('div'); card.className = 'ssc-card';
                    const delBtn = state.mode === 'generic' ? `<button class="ssc-del-cat" onclick="sscDeleteCategory('${c.id}')">Ã—</button>` : '';
                    card.innerHTML = `${delBtn}<h3>${c.name}</h3><div class="ssc-meta">${info.desc}</div><div class="ssc-counter"><div class="ssc-iconbtn" onclick="sscUpdateCount('${c.id}', -1)">âˆ’</div><div class="ssc-count">${n}</div><div class="ssc-iconbtn" onclick="sscUpdateCount('${c.id}', 1)">+</div></div><div class="ssc-meta" style="text-align:end">×¡×”×´×›: <b>${fmt(subtotal)}</b></div>`;
                    els.grid.appendChild(card);
                });
            }

            function renderQuick(){
                els.quick.innerHTML = '';
                state.quickRows.forEach((r, i) => {
                    const div = document.createElement('div'); div.className = 'ssc-editor-slice';
                    div.innerHTML = `<input type="number" class="ssc-inp" value="${r.h}" step="0.5" onchange="sscUpdateQuick(${i}, 'h', this.value)" placeholder="×©×¢×•×ª" style="width:70px"><span>×‘-</span><input type="number" class="ssc-inp" value="${r.p}" onchange="sscUpdateQuick(${i}, 'p', this.value)" placeholder="%" style="width:60px"><button class="ssc-btn ghost danger" onclick="sscRemoveQuick(${i})">Ã—</button>`;
                    els.quick.appendChild(div);
                });
            }

            function calcAndRenderTotals(){
                let shifts=0, hours=0, money=0;
                let tbodyHtml = '';
                state.categories.forEach(c => {
                    const n = state.counts[c.id] || 0;
                    if(n > 0){
                        const info = getShiftInfo(c);
                        const subMoney = payForShift(c) * n;
                        const subHours = info.totalHours * n;
                        shifts += n; hours += subHours; money += subMoney;
                        tbodyHtml += `<tr><td style="text-align:right">${c.name}</td><td>${n}</td><td>${subHours}</td><td>${fmt(subMoney)}</td></tr>`;
                    }
                });
                let qMoney = 0;
                state.quickRows.forEach(r => { qMoney += (state.hourly * (r.p/100) * r.h); });
                if(qMoney > 0 || state.quickRows.length > 0){ money += qMoney; tbodyHtml += `<tr><td colspan="3" style="text-align:right">×—×•×¤×©×™</td><td>${fmt(qMoney)}</td></tr>`; }
                els.tShifts.textContent = shifts; els.tHours.textContent = parseFloat(hours.toFixed(2)); els.gTotal.textContent = fmt(money);
                els.details.innerHTML = tbodyHtml; els.dTotal.textContent = fmt(money); els.quickSum.textContent = fmt(qMoney);
            }

            function getShiftInfo(c){ let h=0; const parts = c.slices.map(s => { h += +s.h; return `${s.p}%Ã—${s.h}×©×³`; }); return { totalHours: h, desc: `${h} ×©×¢×•×ª (${parts.join(' + ')})` }; }
            function payForShift(c){ if(!state.hourly) return 0; return c.slices.reduce((sum, s) => sum + (state.hourly * (s.p/100) * s.h), 0); }
            function fmt(n){ return state.currency + n.toLocaleString('he-IL', {maximumFractionDigits:0}); }

            // Global handlers for HTML onClick
            window.sscUpdateCount = (id, delta) => { state.counts[id] = Math.max(0, (state.counts[id]||0) + delta); saveData(); renderAll(); };
            window.sscDeleteCategory = (id) => { if(!confirm('×œ××—×•×§?')) return; state.categories = state.categories.filter(c => c.id !== id); delete state.counts[id]; saveData(); renderAll(); };
            window.sscUpdateQuick = (i, k, v) => { state.quickRows[i][k] = +v; saveData(); renderAll(); };
            window.sscRemoveQuick = (i) => { state.quickRows.splice(i, 1); saveData(); renderAll(); };

            // Events
            els.hourly.oninput = () => { state.hourly = +els.hourly.value; saveData(); renderAll(); };
            els.cur.onchange = () => { state.currency = els.cur.value; saveData(); renderAll(); };
            els.month.onchange = () => { state.ym = els.month.value; loadData(); renderAll(); };
            els.resetMonth.onclick = () => { if(confirm('×œ××¤×¡?')){ state.counts={}; state.quickRows=[]; saveData(); renderAll(); }};
            els.addSlice.onclick = () => addEditorSlice();
            els.saveTpl.onclick = () => {
                const name = els.newName.value.trim();
                const slices = [];
                els.newSlices.querySelectorAll('.ssc-editor-slice').forEach(div => {
                    const p = +div.querySelector('.e-p').value; const h = +div.querySelector('.e-h').value;
                    if(h > 0) slices.push({p, h});
                });
                if(!name || !slices.length) return alert('× × ×œ××œ× ×¤×¨×˜×™×');
                state.categories.push({ id: 'g' + Date.now(), name, slices });
                saveData(); renderAll(); resetEditor();
            };
            els.addQuick.onclick = () => { state.quickRows.push({h:0, p:100}); saveData(); renderQuick(); };
            els.secretBtn.onclick = () => {
                const val = els.secret.value.trim().toLowerCase();
                if(val === '××©××¨'){ localStorage.setItem(KEY_MODE, 'mishmar'); location.reload(); }
                else if (val === '×¨×’×™×œ' || val === 'generic') { localStorage.setItem(KEY_MODE, 'generic'); location.reload(); }
                else { alert('×§×•×“ ×©×’×•×™'); }
            };
        }
    </script>
</body>
</html>
